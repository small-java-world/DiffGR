# DiffGR Viewer アプリの使い方

このリポジトリには、DiffGR（差分＋レビュー用メタ情報のJSON）を

- **生成**するスクリプト（git の2つのrefから `.diffgr.json` を作る）
- **閲覧/レビュー**するアプリ（TextualベースのGUIチックUI、またはプロンプトUI）

が入っています。

## 1. セットアップ

Python を使います。

```powershell
cd F:\diffgr
python -m pip install -r requirements.txt
```

## 2. DiffGR を生成する

### 2.1 サンプル（TS20 / 仮想5PR）を生成

ベース/フィーチャrefは次のブランチが前提です。

- base: `samples/ts20-base`
- feature: `samples/ts20-feature-5pr`

生成（`samples/` 配下に保存）:

```powershell
python scripts\generate_diffgr.py `
  --base samples/ts20-base `
  --feature samples/ts20-feature-5pr `
  --output samples/diffgr/ts20-5pr.diffgr.json `
  --title "DiffGR TS20 sample (5 virtual PRs)"
```

デフォルト引数のまま生成（出力は `out/sample-ts20.diffgr.json`）:

```powershell
python scripts\generate_diffgr.py
```

## 3. Viewer を起動する（GUIチック / 推奨）

Textual UI（デフォルト）:

```powershell
python scripts\view_diffgr_app.py samples/diffgr/ts20-5pr.diffgr.json
```

Textual UI が依存関係で動かない場合は、プロンプトUIに切り替えできます:

```powershell
python scripts\view_diffgr_app.py samples/diffgr/ts20-5pr.diffgr.json --ui prompt
```

## 4. レビュー（仮想PR = グループ）操作の考え方

DiffGRでは「1つの大きい差分（1 PR相当）」を、**グループ（slice）**に分けてレビューします。

- グループ = 仮想PR（スライス）
- チャンク = diff の塊（hunk相当）
- 「このチャンクはどの仮想PRに属するか」を **assign** で持つ
- 「このチャンクをレビューしたか」を **reviews.status** で持つ

Textual UI では、**グループを日本語名で作って、チャンクを割り当てていく**前提のUIになっています。

## 5. Textual UI の主な操作（キーボード）

画面上部のナビやショートカット表示に従うのが基本です。代表操作は以下です。

- グループ操作
  - `n`: 新規グループ作成（日本語OK）
  - `e`: 選択中グループ名の変更（日本語OK）
- 割り当て
  - `a`: 選択中チャンクを選択中グループへ割り当て
  - `u`: 選択中チャンクを未割り当てへ戻す
- ステータス（レビュー状態）
  - `1`: unreviewed
  - `2`: reviewed
  - `3`: ignored
  - `4`: needsReReview
- 保存
  - `s`: `.diffgr.json` に保存（同階層に `.bak` を作ってから上書き）
- フィルタ
  - `/`: フィルタ入力（ファイル名部分一致など）
- 終了
  - `q`: 終了

## 6. まず最初にやること（おすすめ手順）

1. Viewer を起動
2. `n` で「仮想PR（日本語名）」を5つ作る（例: `PR1 認証`, `PR2 UI`, ...）
3. チャンクを順に見て `a` で割り当て
4. 各グループ内でレビューし、状態を `2`（reviewed）にしていく
5. `s` で保存して終了

## 7. トラブルシュート

- `textual UI is unavailable` と出る
  - `python -m pip install -r requirements.txt` を実行
  - それでもダメなら `--ui prompt` で起動
- JSONが壊れて読めない
  - 保存時に同階層に作られる `.bak` を戻す

