# DiffGR Viewer アプリの使い方

このリポジトリには、DiffGR（差分＋レビュー用メタ情報のJSON）を

- **生成**するスクリプト（git の2つのrefから `.diffgr.json` を作る）
- **閲覧/レビュー**するアプリ（TextualベースのGUIチックUI、またはプロンプトUI）

が入っています。

## 1. セットアップ

Python を使います。

```powershell
cd F:\diffgr
python -m pip install -r requirements.txt
```

## 2. DiffGR を生成する

### 2.1 サンプル（TS20 / 仮想5PR）を生成

ベース/フィーチャrefは次のブランチが前提です。

- base: `samples/ts20-base`
- feature: `samples/ts20-feature-5pr`

生成（`samples/` 配下に保存）:

```powershell
python scripts\generate_diffgr.py `
  --base samples/ts20-base `
  --feature samples/ts20-feature-5pr `
  --output samples/diffgr/ts20-5pr.diffgr.json `
  --title "DiffGR TS20 sample (5 virtual PRs)"
```

デフォルト引数のまま生成（出力は `out/sample-ts20.diffgr.json`）:

```powershell
python scripts\generate_diffgr.py
```

## 3. Viewer を起動する（GUIチック / 推奨）

Textual UI（デフォルト）:

```powershell
python scripts\view_diffgr_app.py samples/diffgr/ts20-5pr.diffgr.json
```

## 3.5 AI（自動）で仮想PR分割する

サンプルでは、`samples/diffgr/ts20-5pr.diffgr.json` は最初「All Changes 1グループ」に全部入っています。
自動で「仮想PR（グループ）」へ分割したい場合は、コミット単位でスライスします（決定的に再現できます）。

```powershell
python scripts\autoslice_diffgr.py `
  --base samples/ts20-base `
  --feature samples/ts20-feature-5pr `
  --input samples/diffgr/ts20-5pr.diffgr.json `
  --output samples/diffgr/ts20-5pr.autosliced.diffgr.json
```

起動:

```powershell
python scripts\view_diffgr_app.py samples/diffgr/ts20-5pr.autosliced.diffgr.json
```

### 3.6 さらに “いい感じ” に寄せる（グループ名の自動改善＋AI用プロンプト出力）

自動スライスのままだと `PR1/PR2/...` のような名前になりがちなので、差分内容から **日本語の目的名にリネーム**します。
同時に、追加でAIに調整してもらうためのプロンプト（Markdown）も出力できます。

```powershell
python scripts\refine_slices.py `
  --input samples/diffgr/ts20-5pr.autosliced.diffgr.json `
  --output samples/diffgr/ts20-5pr.refined.diffgr.json `
  --write-prompt samples/diffgr/ts20-5pr.refine-prompt.md
```

Viewer 起動:

```powershell
python scripts\view_diffgr_app.py samples/diffgr/ts20-5pr.refined.diffgr.json
```

### 3.6.1 AIの提案を適用する

`samples/diffgr/ts20-5pr.refine-prompt.md` をAIに渡して、返ってきたJSONを `slice_patch.json` として保存したら、
次のスクリプトで反映できます。

Codex CLI / Claude Code CLI に “投げて” パッチJSONを作らせる場合は、設定ファイル `agent_cli.toml` を用意してから
次のスクリプトを使えます。

```powershell
python scripts\run_agent_cli.py `
  --config agent_cli.toml `
  --prompt samples/diffgr/ts20-5pr.refine-prompt.md `
  --output slice_patch.json
```

会話しながら決めたい場合（おすすめ）は `--interactive` を付けます。
CLIが対話セッションを開始するので、そこで**対話で情報（分割要約Markdownなど）を渡して**方針を決めます。
セッション終了後に直近セッションを継続して `slice_patch.json` を出力します。

```powershell
python scripts\run_agent_cli.py `
  --config agent_cli.toml `
  --prompt samples/diffgr/ts20-5pr.refine-prompt.md `
  --output slice_patch.json `
  --interactive
```

プロンプトMarkdownをすぐ貼れるように、必要なら `--copy-prompt` を付けるとクリップボードへコピーします（Windows）。

```powershell
python scripts\run_agent_cli.py `
  --config agent_cli.toml `
  --prompt samples/diffgr/ts20-5pr.refine-prompt.md `
  --output slice_patch.json `
  --interactive `
  --copy-prompt
```

AIへの依頼で重要な点:

- **返答はJSONだけ**（説明文なし）にしてもらう（そのまま `slice_patch.json` に保存できるように）
- **グループID（`g-pr01` など）/ chunk_id はこのファイル内のものだけ**を使う
- **全チャンクが必ずどれか1グループに属する**ようにする（= moveで移動するなら必ず行き先を指定）
- グループ名は **短い日本語の目的名**（例: 「入力正規化」「計算ロジック」）

パッチJSONの形式:

```json
{
  "rename": { "g-id": "新しい名前" },
  "move": [
    { "chunk": "chunk_id", "to": "g-id" }
  ]
}
```

```powershell
python scripts\apply_slice_patch.py `
  --input samples/diffgr/ts20-5pr.refined.diffgr.json `
  --patch slice_patch.json `
  --output samples/diffgr/ts20-5pr.ai-refined.diffgr.json
```

```powershell
python scripts\view_diffgr_app.py samples/diffgr/ts20-5pr.ai-refined.diffgr.json
```

### 3.6.2 「自動分割」→「AIでブラッシュアップ」がおすすめな理由

- 自動分割は **決定的**で再現できる（同じbase/featureなら同じ結果）
- AIは「この分割、レビューしづらい」を見つけて、
  - グループの統合/分割（moveで調整）
  - 日本語の目的名付け（rename）
  を行える
- 人手のUI操作（チャンク割り当て）を最小化できる

### 3.7 生成→自動分割→自動リネーム を一発でやる

```powershell
python scripts\prepare_review.py `
  --base samples/ts20-base `
  --feature samples/ts20-feature-5pr `
  --output samples/diffgr/ts20-5pr.review.diffgr.json `
  --title "DiffGR TS20 review bundle"
```

```powershell
python scripts\view_diffgr_app.py samples/diffgr/ts20-5pr.review.diffgr.json
```

Textual UI が依存関係で動かない場合は、プロンプトUIに切り替えできます:

```powershell
python scripts\view_diffgr_app.py samples/diffgr/ts20-5pr.diffgr.json --ui prompt
```

## 4. レビュー（仮想PR = グループ）操作の考え方

DiffGRでは「1つの大きい差分（1 PR相当）」を、**グループ（slice）**に分けてレビューします。

- グループ = 仮想PR（スライス）
- チャンク = diff の塊（hunk相当）
- 「このチャンクはどの仮想PRに属するか」を **assign** で持つ
- 「このチャンクをレビューしたか」を **reviews.status** で持つ

Textual UI では、**グループを日本語名で作って、チャンクを割り当てていく**前提のUIになっています。
ただし「AIで仮想PR分割を作る」運用では、基本的に `3.5〜3.6` のスクリプトで割り当てまで済ませてから Viewer を開くのがおすすめです。

## 5. Textual UI の主な操作（キーボード）

画面上部のナビやショートカット表示に従うのが基本です。代表操作は以下です。

- グループ操作
  - `n`: 新規グループ作成（日本語OK）
  - `e`: 選択中グループ名の変更（日本語OK）
- 割り当て
  - `a`: 選択中チャンクを選択中グループへ割り当て
  - `u`: 選択中チャンクを未割り当てへ戻す
- ステータス（レビュー状態）
  - `1`: unreviewed
  - `2`: reviewed
  - `3`: ignored
  - `4`: needsReReview
- 保存
  - `s`: `.diffgr.json` に保存（同階層に `.bak` を作ってから上書き）
- フィルタ
  - `/`: フィルタ入力（ファイル名部分一致など）
- 終了
  - `q`: 終了

## 6. まず最初にやること（おすすめ手順）

### 6.1 AI前提（おすすめ）

1. `python scripts\prepare_review.py ...` で review用 `.diffgr.json` を作る
2. `python scripts\view_diffgr_app.py ...` で Viewer を起動
3. 必要なら `refine_slices.py` が出したプロンプトでAIにブラッシュアップさせ、`apply_slice_patch.py` で反映
4. Viewer上でレビュー状態を付けて `s` で保存

### 6.2 手動割り当て

1. Viewer を起動
2. `n` で「仮想PR（日本語名）」を5つ作る（例: `PR1 認証`, `PR2 UI`, ...）
3. チャンクを順に見て `a` で割り当て
4. 各グループ内でレビューし、状態を `2`（reviewed）にしていく
5. `s` で保存して終了

## 7. トラブルシュート

- `textual UI is unavailable` と出る
  - `python -m pip install -r requirements.txt` を実行
  - それでもダメなら `--ui prompt` で起動
- JSONが壊れて読めない
  - 保存時に同階層に作られる `.bak` を戻す
